<!doctype html>
<html lang="zh-Hans">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AI封装生成器</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
				background: #f0f0f0;
				height: 100vh;
				overflow: hidden;
			}

			.header {
				background: white;
				padding: 12px 20px;
				border-bottom: 1px solid #e0e0e0;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.header h1 {
				font-size: 16px;
				font-weight: normal;
				color: #333;
			}

			.close-btn {
				background: none;
				border: none;
				font-size: 20px;
				cursor: pointer;
				color: #666;
				width: 30px;
				height: 30px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.close-btn:hover {
				background: #f5f5f5;
				border-radius: 4px;
			}

			.container {
				display: flex;
				height: calc(100vh - 55px);
				overflow: hidden;
			}

			.left-panel {
				flex: 1;
				background: white;
				display: flex;
				flex-direction: column;
				border-right: 2px dashed #e0e0e0;
				position: relative;
				overflow: hidden;
				min-width: 0;
			}

			.upload-btn-container {
				padding: 15px;
				border-bottom: 1px solid #e0e0e0;
				display: flex;
				align-items: center;
				gap: 15px;
			}

			.upload-btn {
				background: #1890ff;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
			}

			.upload-btn:hover {
				background: #40a9ff;
			}

			.pdf-controls {
				/* position: absolute; */
				bottom: 0;
				left: 0;
				right: 0;
				background: rgba(255, 255, 255, 0.98);
				backdrop-filter: blur(10px);
				border-top: 1px solid #e0e0e0;
				padding: 12px 20px;
				display: none;
				align-items: center;
				justify-content: center;
				gap: 30px;
				box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
				z-index: 10;
			}

			.pdf-controls.show {
				display: flex;
			}

			.pdf-controls.show {
				display: flex;
			}

			.page-nav {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.page-nav button {
				background: #1890ff;
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				transition: background 0.2s;
			}

			.page-nav button:hover:not(:disabled) {
				background: #40a9ff;
			}

			.page-nav button:disabled {
				background: #d9d9d9;
				cursor: not-allowed;
			}

			.page-nav input {
				width: 60px;
				padding: 8px 10px;
				border: 1px solid #d9d9d9;
				border-radius: 4px;
				text-align: center;
				font-size: 14px;
			}

			.page-nav span {
				color: #666;
				font-size: 14px;
			}

			.divider {
				width: 1px;
				height: 24px;
				background: #d9d9d9;
			}

			.zoom-controls {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.zoom-controls button {
				background: #1890ff;
				color: white;
				border: none;
				padding: 8px 14px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 16px;
				min-width: 36px;
				height: 36px;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: background 0.2s;
			}

			.zoom-controls button:hover {
				background: #40a9ff;
			}

			.zoom-controls .reset-btn {
				font-size: 14px;
				padding: 8px 16px;
			}

			.zoom-controls span {
				color: #333;
				font-size: 14px;
				min-width: 60px;
				text-align: center;
				font-weight: 500;
			}

			.pdf-viewer {
				flex: 1;
				align-items: center;
				justify-content: center;
				color: #999;
				font-size: 16px;
				position: relative;
				overflow: auto;
				cursor: pointer;
			}

			.pdf-viewer.has-content {
				cursor: default;
			}

			.pdf-viewer.empty {
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.pdf-viewer.empty::before {
				content: '请上传PDF文件';
				color: #999;
				font-size: 16px;
			}

			.pdf-viewer.drag-over {
				background: #e6f7ff;
				border: 2px dashed #1890ff;
			}

			.pdf-viewer canvas {
				max-width: none;
				max-height: none;
				width: auto;
				height: auto;
			}

			.right-panel {
				width: 600px;
				background: white;
				display: flex;
				flex-direction: column;
			}

			.top-actions {
				padding: 15px 20px;
				border-bottom: 1px solid #e0e0e0;
			}

			.fetch-btn {
				background: #52c41a;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
			}

			.fetch-btn:hover {
				background: #73d13d;
			}

			.fetch-btn:disabled {
				background: #d9d9d9;
				cursor: not-allowed;
			}

			.results-container {
				flex: 1;
				overflow: auto;
				padding: 20px;
			}

			.package-section {
				margin-bottom: 30px;
				border: 1px solid #e0e0e0;
				border-radius: 4px;
				padding: 15px;
				background: #fafafa;
			}

			.package-info {
				display: flex;
				gap: 30px;
				margin-bottom: 15px;
				padding-bottom: 10px;
				border-bottom: 1px solid #e0e0e0;
			}

			.info-item {
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.info-label {
				font-weight: 500;
				color: #666;
				font-size: 14px;
			}

			.info-value {
				color: #333;
				font-size: 14px;
			}

			.button-group {
				display: flex;
				gap: 10px;
				margin-bottom: 15px;
			}

			.add-btn {
				background: #52c41a;
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
			}

			.add-btn:hover {
				background: #73d13d;
			}

			.clear-btn {
				background: #ff4d4f;
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
			}

			.clear-btn:hover {
				background: #ff7875;
			}

			.create-btn {
				background: #1890ff;
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
			}

			.create-btn:hover {
				background: #40a9ff;
			}

			table {
				width: 100%;
				border-collapse: collapse;
				background: white;
			}

			th {
				background: #fafafa;
				padding: 12px;
				text-align: left;
				border: 1px solid #e0e0e0;
				font-weight: normal;
				color: #666;
				font-size: 14px;
			}

			td {
				padding: 8px 12px;
				border: 1px solid #e0e0e0;
				background: white;
			}

			td input {
				width: 100%;
				border: 1px solid #d9d9d9;
				padding: 6px 10px;
				border-radius: 2px;
				font-size: 14px;
			}

			td input:focus {
				outline: none;
				border-color: #1890ff;
			}

			.delete-btn {
				background: #ff4d4f;
				color: white;
				border: none;
				padding: 6px 12px;
				border-radius: 2px;
				cursor: pointer;
				font-size: 12px;
				width: 100%;
			}

			.delete-btn:hover {
				background: #ff7875;
			}

			.empty-message {
				text-align: center;
				color: #999;
				padding: 40px;
				font-size: 14px;
			}

			input[type='file'] {
				display: none;
			}

			.loading {
				text-align: center;
				color: #1890ff;
				padding: 20px;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="left-panel">
				<div class="upload-btn-container">
					<input type="file" id="fileInput" accept=".pdf,image/*" />
					<button class="upload-btn" onclick="document.getElementById('fileInput').click()">上传PDF</button>
					<button class="upload-btn" id="hideWindowBtn">隐藏窗口</button>
				</div>
				<div class="pdf-viewer empty" id="pdfViewer"></div>

				<!-- PDF控制栏 -->
				<div class="pdf-controls" id="pdfControls">
					<div class="page-nav">
						<button id="prevPageBtn">&lt;</button>
						<input type="number" id="pageInput" min="1" value="1" />
						<span id="pageInfo">/ 1</span>
						<button id="nextPageBtn">&gt;</button>
					</div>

					<div class="divider"></div>

					<div class="zoom-controls">
						<button id="zoomOutBtn" title="缩小">−</button>
						<span id="zoomLevel">100%</span>
						<button id="zoomInBtn" title="放大">+</button>
						<button class="reset-btn" id="zoomResetBtn">重置</button>
					</div>
				</div>
			</div>

			<div class="right-panel">
				<div class="top-actions">
					<button class="fetch-btn" id="fetchResultBtn" disabled>获取解析结果</button>
				</div>
				<div class="results-container" id="resultsContainer">
					<div class="empty-message">请先上传PDF文件并点击"获取解析结果"</div>
				</div>
			</div>
		</div>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.149/pdf.min.mjs" type="module"></script>
		<script type="module">
			import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.149/pdf.min.mjs';

			pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.149/pdf.worker.min.mjs';

			window.pdfjsLib = pdfjsLib;
		</script>
		<script>
			const fileInput = document.getElementById('fileInput');
			const pdfViewer = document.getElementById('pdfViewer');
			const fetchResultBtn = document.getElementById('fetchResultBtn');
			const resultsContainer = document.getElementById('resultsContainer');
			const pdfControls = document.getElementById('pdfControls');
			const pageInput = document.getElementById('pageInput');
			const pageInfo = document.getElementById('pageInfo');
			const prevPageBtn = document.getElementById('prevPageBtn');
			const nextPageBtn = document.getElementById('nextPageBtn');
			const zoomInBtn = document.getElementById('zoomInBtn');
			const zoomOutBtn = document.getElementById('zoomOutBtn');
			const zoomResetBtn = document.getElementById('zoomResetBtn');
			const zoomLevel = document.getElementById('zoomLevel');
			const packageParams = {
				'BGA': [
					{ name: '引脚行数', key: 'pin_rows', unit: '' },
					{ name: '引脚列数', key: 'pin_cols', unit: '' },
					{ name: '本体长度(BL)', key: 'body_length', unit: 'mm' },
					{ name: '本体宽度(BW)', key: 'body_width', unit: 'mm' },
					{ name: '引脚直径(PD)', key: 'pin_diameter', unit: 'mm' },
					{ name: '引脚间距(PS)', key: 'pin_spacing', unit: 'mm' },
					{ name: '引脚纵向间距(PP)', key: 'pin_pitch', unit: 'mm' },
				],
				'QFN': [
					{ name: '引脚数(左右)', key: 'pin_count_lr', unit: '' },
					{ name: '引脚数(上下)', key: 'pin_count_tb', unit: '' },
					{ name: '本体长度(BL)', key: 'body_length', unit: 'mm' },
					{ name: '本体宽度(BW)', key: 'body_width', unit: 'mm' },
					{ name: '引脚长度(PL)', key: 'pin_length', unit: 'mm' },
					{ name: '引脚宽度(PW)', key: 'pin_width', unit: 'mm' },
					{ name: '引脚间距(PP)', key: 'pin_pitch', unit: 'mm' },
				],
				'SOIC': [
					{ name: '引脚数量', key: 'Pin Count', unit: '' },
					{ name: '引脚跨距(LS)', key: 'Overall Width', unit: 'mm' },
					{ name: '本体长度(BL)', key: 'Package Body Length', unit: 'mm' },
					{ name: '本体宽度(BW)', key: 'Package Body Width', unit: 'mm' },
					{ name: '引脚长度(PL)', key: 'Foot Length', unit: 'mm' },
					{ name: '引脚宽度(PW)', key: 'Lead Width', unit: 'mm' },
					{ name: '引脚间距(PP)', key: 'Pitch', unit: 'mm' },
				],
			};

			let currentDatasheetUuid = null;
			let currentPdf = null;
			let currentPageNum = 1;
			let totalPages = 0;
			let currentScale = 1.0;

			// 文件上传处理
			fileInput.addEventListener('change', handleFileSelect);

			// 点击PDF viewer区域也可以上传
			pdfViewer.addEventListener('click', () => {
				// 只有在空白状态时才触发上传
				if (pdfViewer.classList.contains('empty')) {
					fileInput.click();
				}
			});

			// 隐藏窗口功能
			const hideWindowBtn = document.getElementById('hideWindowBtn');
			hideWindowBtn.addEventListener('click', () => {
				eda.sys_IFrame.hideIFrame('footprint');
				eda.sys_ToastMessage.showMessage('页面已隐藏，可点击继续重新打开页面', 0);
			});

			async function handleFileSelect(e) {
				const file = e.target.files[0];
				if (!file) return;

				// 如果是图片文件
				if (file.type.startsWith('image/')) {
					const reader = new FileReader();
					reader.onload = function (e) {
						pdfViewer.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 100%;">`;
						pdfViewer.classList.add('has-content');
						pdfViewer.classList.remove('empty');
						pdfControls.classList.remove('show');
					};
					reader.readAsDataURL(file);
					uploadFile(file); // 不等待上传结果
					return;
				}

				// 如果是PDF文件
				if (file.type === 'application/pdf') {
					const reader = new FileReader();
					reader.onload = async function (e) {
						try {
							// 确保PDF.js已加载
							if (typeof pdfjsLib === 'undefined' || !window.pdfjsLib) {
								pdfViewer.innerHTML = 'PDF库加载失败，请刷新页面重试';
								return;
							}

							const loadingTask = window.pdfjsLib.getDocument({ data: e.target.result });
							currentPdf = await loadingTask.promise;
							totalPages = currentPdf.numPages;
							currentPageNum = 1;

							// 显示底部控制栏
							pdfControls.classList.add('show');
							pageInput.max = totalPages;
							pageInput.value = 1;
							pageInfo.textContent = `/ ${totalPages}`;
							updateZoomLevel();

							// 渲染第一页
							await renderPage(1);
						} catch (error) {
							console.error('PDF渲染错误:', error);
							pdfViewer.innerHTML = 'PDF加载失败: ' + error.message;
							pdfControls.classList.remove('show');
						}
					};
					reader.readAsArrayBuffer(file);
					uploadFile(file); // 不等待上传结果
				}
			}

			// 渲染指定页面
			async function renderPage(pageNum) {
				if (!currentPdf || pageNum < 1 || pageNum > totalPages) return;

				try {
					const page = await currentPdf.getPage(pageNum);
					const viewport = page.getViewport({ scale: currentScale });

					const canvas = document.createElement('canvas');
					const context = canvas.getContext('2d');
					canvas.height = viewport.height;
					canvas.width = viewport.width;
					pdfViewer.innerHTML = '';
					pdfViewer.appendChild(canvas);

					await page.render({ canvasContext: context, viewport: viewport }).promise;

					pdfViewer.classList.add('has-content');
					pdfViewer.classList.remove('empty');

					currentPageNum = pageNum;
					pageInput.value = pageNum;

					// 更新按钮状态
					prevPageBtn.disabled = pageNum <= 1;
					nextPageBtn.disabled = pageNum >= totalPages;
				} catch (error) {
					console.error('页面渲染错误:', error);
				}
			}

			// 页码导航事件
			prevPageBtn.addEventListener('click', () => {
				if (currentPageNum > 1) {
					renderPage(currentPageNum - 1);
				}
			});

			nextPageBtn.addEventListener('click', () => {
				if (currentPageNum < totalPages) {
					renderPage(currentPageNum + 1);
				}
			});

			pageInput.addEventListener('change', (e) => {
				let pageNum = parseInt(e.target.value);
				if (pageNum < 1) pageNum = 1;
				if (pageNum > totalPages) pageNum = totalPages;
				renderPage(pageNum);
			});

			pageInput.addEventListener('keypress', (e) => {
				if (e.key === 'Enter') {
					let pageNum = parseInt(e.target.value);
					if (pageNum < 1) pageNum = 1;
					if (pageNum > totalPages) pageNum = totalPages;
					renderPage(pageNum);
				}
			});

			// 缩放控制
			zoomInBtn.addEventListener('click', () => {
				currentScale = Math.min(currentScale + 0.25, 3.0);
				updateZoomLevel();
				if (currentPdf) {
					renderPage(currentPageNum);
				}
			});

			zoomOutBtn.addEventListener('click', () => {
				currentScale = Math.max(currentScale - 0.25, 0.5);
				updateZoomLevel();
				if (currentPdf) {
					renderPage(currentPageNum);
				}
			});

			zoomResetBtn.addEventListener('click', () => {
				currentScale = 1.0;
				updateZoomLevel();
				if (currentPdf) {
					renderPage(currentPageNum);
				}
			});

			function updateZoomLevel() {
				const percentage = Math.round(currentScale * 100);
				zoomLevel.textContent = `${percentage}%`;
			}

			// 上传文件到服务器（不阻塞PDF显示）
			async function uploadFile(file) {
				const formData = new FormData();
				formData.append('file', file);

				try {
					const response = await eda.sys_ClientUrl.request('http://localhost:8080/api/packages/upload', 'POST', formData);

					if (response.ok) {
						const result = await response.json();
						console.log('上传成功:', result);

						// 保存uuid并启用获取结果按钮
						if (result.uuid) {
							currentDatasheetUuid = result.uuid;
							fetchResultBtn.disabled = false;
							eda.sys_ToastMessage.showMessage('文件上传成功！', 3);
						}
					} else {
						console.error('上传失败:', response.statusText);
						// 不显示错误提示，仅在控制台记录
					}
				} catch (error) {
					console.error('上传错误:', error);
					// 不显示错误提示，仅在控制台记录
				}
			}

			// 拖拽上传
			pdfViewer.addEventListener('dragover', (e) => {
				e.preventDefault();
				pdfViewer.classList.add('drag-over');
			});

			pdfViewer.addEventListener('dragleave', (e) => {
				e.preventDefault();
				pdfViewer.classList.remove('drag-over');
			});

			pdfViewer.addEventListener('drop', async (e) => {
				e.preventDefault();
				pdfViewer.classList.remove('drag-over');

				const file = e.dataTransfer.files[0];
				if (file) {
					fileInput.files = e.dataTransfer.files;
					handleFileSelect({ target: fileInput });
				}
			});

			// 获取解析结果
			fetchResultBtn.addEventListener('click', async () => {
				if (!currentDatasheetUuid) {
					eda.sys_ToastMessage.showMessage('请先上传PDF文件', 3);
					return;
				}

				resultsContainer.innerHTML = '<div class="loading">正在获取解析结果...</div>';

				try {
					const response = await eda.sys_ClientUrl.request(`http://localhost:8080/api/packages/${currentDatasheetUuid}`);

					if (response.ok) {
						const data = await response.json();
						console.log('解析结果:', data);
						displayResults(data);
					} else {
						console.error('获取失败:', response.statusText);
						resultsContainer.innerHTML = '<div class="empty-message">获取解析结果失败，请重试</div>';
					}
				} catch (error) {
					console.error('请求错误:', error);
					resultsContainer.innerHTML = '<div class="empty-message">请求出错：' + error.message + '</div>';
				}
			});

			// 显示解析结果
			function displayResults(data) {
				if (!data || data.length === 0) {
					resultsContainer.innerHTML = '<div class="empty-message">暂无解析结果</div>';
					return;
				}

				resultsContainer.innerHTML = '';

				data.forEach((item, index) => {
					if (item.packageResult && item.packageResult.trim() !== '') {
						const section = document.createElement('div');
						section.className = 'package-section';
						section.dataset.index = index;
						section.dataset.packageType = item.packageType;
						section.dataset.packageId = item.packageId;

						// 解析packageResult JSON字符串
						let packageData = {};
						try {
							packageData = JSON.parse(item.packageResult);
							section.dataset.packageResult = JSON.stringify(packageData);
						} catch (e) {
							console.error('解析packageResult失败:', e);
						}

						section.innerHTML = `
			                 <div class="package-info">
			                     <div class="info-item">
			                         <span class="info-label">封装类型:</span>
			                         <span class="info-value">${item.packageType || '--'}</span>
			                     </div>
			                     <div class="info-item">
			                         <span class="info-label">封装名称:</span>
			                         <input type="text" class="info-value" id="packageName${index}" value="${item.packageName || ''}" style="border: 1px solid #d9d9d9; padding: 4px 8px; border-radius: 2px;">
			                     </div>
			                     <div class="info-item">
			                         <span class="info-label">页码:</span>
			                         <input type="text" class="info-value" id="pageNumbers${index}" value="${item.pageNumbers || ''}" placeholder="1,2,3" style="border: 1px solid #d9d9d9; padding: 4px 8px; border-radius: 2px; width: 100px;">
			                     	<button class="locate-btn" onclick="locateToPage(${index})" style="background: #52c41a; color: white; border: none; padding: 4px 12px; border-radius: 2px; cursor: pointer; font-size: 12px; margin-left: 5px;">定位</button>
								</div>
			                 </div>
			                 <div class="button-group">
			                     <button class="add-btn" onclick="addParamRow(${index})">添加参数</button>
			                     <button class="clear-btn" onclick="clearTable(${index})">清空表格</button>
			                     <button class="create-btn" onclick="createPackage(${index}, '${item.packageId}')">创建封装</button>
			                 </div>
			                 <table>
			                     <thead>
			                         <tr>
			                             <th>参数名称</th>
			                             <th>数值</th>
			                             <th>单位</th>
			                             <th>操作</th>
			                         </tr>
			                     </thead>
			                     <tbody id="tableBody${index}">
			                     </tbody>
			                 </table>
			             `;

						resultsContainer.appendChild(section);

						// 填充表格数据
						const tbody = document.getElementById(`tableBody${index}`);
						const paramMapping = packageParams[item.packageType] || [];

						// 如果有参数映射，按照映射顺序显示
						if (paramMapping.length > 0) {
							paramMapping.forEach((param) => {
								const value = packageData[param.key] || '';
								const row = tbody.insertRow();
								row.innerHTML = `
			                         <td><input type="text" value="${param.name}" readonly data-key="${param.key}"></td>
			                         <td><input type="text" value="${value}"></td>
			                         <td><input type="text" value="${param.unit}"></td>
			                         <td><button class="delete-btn" onclick="deleteRow(this)">删除</button></td>
			                     `;
							});
						} else {
							// 没有映射配置时，使用原始key
							for (const [key, value] of Object.entries(packageData)) {
								const row = tbody.insertRow();
								row.innerHTML = `
			                         <td><input type="text" value="${key}" data-key="${key}"></td>
			                         <td><input type="text" value="${value}"></td>
			                         <td><input type="text" value="mm"></td>
			                         <td><button class="delete-btn" onclick="deleteRow(this)">删除</button></td>
			                     `;
							}
						}
					}
				});
			}

			// 添加参数行
			function addParamRow(index) {
				const tbody = document.getElementById(`tableBody${index}`);
				const row = tbody.insertRow();
				row.innerHTML = `
			             <td><input type="text" placeholder="新参数"></td>
			             <td><input type="text" placeholder=""></td>
			             <td><input type="text" value="mm"></td>
			             <td><button class="delete-btn" onclick="deleteRow(this)">删除</button></td>
			         `;
			}

			// 删除行
			function deleteRow(btn) {
				btn.closest('tr').remove();
			}

			// 清空表格
			function clearTable(index) {
				if (confirm('确定要清空所有参数吗？')) {
					const tbody = document.getElementById(`tableBody${index}`);
					tbody.innerHTML = '';
				}
			}

			// 创建封装
			async function createPackage(index, packageId) {
				const section = document.querySelector(`.package-section[data-index="${index}"]`);
				const tbody = document.getElementById(`tableBody${index}`);
				const rows = tbody.querySelectorAll('tr');

				// 先获取原始的完整数据
				let packageResult = {};
				try {
					packageResult = JSON.parse(section.dataset.packageResult || '{}');
				} catch (e) {
					console.error('解析原始数据失败:', e);
				}

				// 用表格中的数据更新packageResult（覆盖或新增）
				rows.forEach((row) => {
					const inputs = row.querySelectorAll('input');
					const nameInput = inputs[0];
					const paramValue = inputs[1].value.trim();

					// 优先使用 data-key，如果没有则使用显示的值
					const paramKey = nameInput.getAttribute('data-key') || nameInput.value.trim();

					if (paramKey) {
						packageResult[paramKey] = paramValue;
					}
				});

				// 获取封装名称和页码
				const packageName = document.getElementById(`packageName${index}`).value.trim();
				const pageNumbers = document.getElementById(`pageNumbers${index}`).value.trim();
				const packageType = section.dataset.packageType;

				if (!packageName) {
					eda.sys_ToastMessage.showMessage('请输入封装名称', 3);
					return;
				}

				if (!pageNumbers) {
					eda.sys_ToastMessage.showMessage('请输入页码', 5);
					return;
				}

				try {
					const headers = {
						'Content-Type': 'application/json',
						'Accept': 'application/json',
					};
					const url = `http://localhost:8080/api/packages/${packageId}?packageName=${encodeURIComponent(packageName)}&pageNumbers=${encodeURIComponent(pageNumbers)}`;
					const body = {
						packageResult: JSON.stringify(packageResult),
					};
					const response = await eda.sys_ClientUrl.request(url, 'PUT', JSON.stringify(body), { headers: headers });

					if (response.ok) {
						const result = await response.json();
						console.log('封装创建成功:', result);

						// 根据封装类型调用对应的创建函数
						if (packageType === 'SOIC') {
							createSOPFootprint(packageResult);
							eda.sys_IFrame.hideIFrame('footprint');
							eda.sys_ToastMessage.showMessage('封装创建成功，支持在菜单中通过点击"继续"选项以重新打开窗口', 3);
						}
						// 可以在这里添加其他封装类型的处理

						eda.sys_ToastMessage.showMessage('封装创建成功！', 3);
					} else {
						console.error('封装创建失败:', response.statusText);
						eda.sys_ToastMessage.showMessage('封装创建失败：' + response.statusText, 3);
					}
				} catch (error) {
					console.error('请求错误:', error);
					eda.sys_ToastMessage.showMessage('封装创建出错：' + error.message, 3);
				}
			}

			// 定位到页码
			function locateToPage(index) {
				const pageNumbersInput = document.getElementById(`pageNumbers${index}`);
				const pageNumbersStr = pageNumbersInput.value.trim();

				if (!pageNumbersStr) {
					eda.sys_ToastMessage.showMessage('请先输入页码', 3);
					return;
				}

				if (!currentPdf) {
					eda.sys_ToastMessage.showMessage('请先上传PDF文件', 3);
					return;
				}

				// 解析页码字符串，支持逗号分隔
				const pageNumbers = pageNumbersStr
					.split(',')
					.map((p) => parseInt(p.trim()))
					.filter((p) => !isNaN(p));

				if (pageNumbers.length === 0) {
					alert('页码格式不正确，请使用逗号分隔，如：1,2,3');
					return;
				}

				// 跳转到第一个页码
				const targetPage = pageNumbers[0];

				if (targetPage < 1 || targetPage > totalPages) {
					eda.sys_ToastMessage.showMessage(`页码 ${targetPage} 超出范围（1-${totalPages}）`, 3);
					return;
				}

				// 跳转到目标页
				renderPage(targetPage);
			}

			function createSOPFootprint(params) {
				console.log('创建SOP封装:', params);

				// 获取参数，设置默认值
				const pinCount = parseInt(params['Pin Count']) || 8;
				const overallWidth = parseFloat(params['Overall Width']) || 5.8;
				const packageBodyLength = parseFloat(params['Package Body Length']) || 4.9;
				const packageBodyWidth = parseFloat(params['Package Body Width']) || 3.9;
				const footLength = parseFloat(params['Foot Length']) || 0.6;
				const leadWidth = parseFloat(params['Lead Width']) || 0.4;
				const pitch = parseFloat(params['Pitch']) || 1.27;
				console.log('参数:', {
					pinCount,
					overallWidth,
					packageBodyLength,
					packageBodyWidth,
					footLength,
					leadWidth,
					pitch,
				});
				// 转换为EDA单位(mil，1mm = 39.3701mil)
				const mmToMil = 39.3701;
				const overallWidthMil = overallWidth * mmToMil;
				const packageBodyLengthMil = packageBodyLength * mmToMil;
				const packageBodyWidthMil = packageBodyWidth * mmToMil;
				const footLengthMil = footLength * mmToMil;
				const leadWidthMil = leadWidth * mmToMil;
				const pitchMil = pitch * mmToMil;

				const pinsPerSide = pinCount / 2;
				let pinNumber = 1;

				// 左侧引脚
				for (let i = 0; i < pinsPerSide; i++) {
					const y = ((pinsPerSide - 1) * pitchMil) / 2 - i * pitchMil;
					const x = -overallWidthMil / 2;
					eda.pcb_PrimitivePad.create(EPCB_LayerId.TOP, pinNumber.toString(), x, y, 0, [
						EPCB_PrimitivePadShapeType.RECTANGLE,
						footLengthMil,
						leadWidthMil,
						0,
					]);
					pinNumber++;
				}

				// 右侧引脚
				for (let i = 0; i < pinsPerSide; i++) {
					const y = (-(pinsPerSide - 1) * pitchMil) / 2 + i * pitchMil;
					const x = overallWidthMil / 2;
					eda.pcb_PrimitivePad.create(EPCB_LayerId.TOP, pinNumber.toString(), x, y, 0, [
						EPCB_PrimitivePadShapeType.RECTANGLE,
						footLengthMil,
						leadWidthMil,
						0,
					]);
					pinNumber++;
				}

				// 创建丝印轮廓
				const silkOffset = 6;
				const outlineX = packageBodyWidthMil / 2 + silkOffset;
				const outlineY = packageBodyLengthMil / 2 + silkOffset;

				const leftLine = eda.pcb_MathPolygon.createPolygon([-outlineX, outlineY, 'L', -outlineX, -outlineY]);
				eda.pcb_PrimitivePolyline.create('line', EPCB_LayerId.TOP_SILKSCREEN, leftLine, 6);

				const rightLine = eda.pcb_MathPolygon.createPolygon([outlineX, outlineY, 'L', outlineX, -outlineY]);
				eda.pcb_PrimitivePolyline.create('line', EPCB_LayerId.TOP_SILKSCREEN, rightLine, 6);

				const bottomLine = eda.pcb_MathPolygon.createPolygon([-outlineX, -outlineY, 'L', outlineX, -outlineY]);
				eda.pcb_PrimitivePolyline.create('line', EPCB_LayerId.TOP_SILKSCREEN, bottomLine, 6);

				const arcGap = 40;
				const leftShortLine = eda.pcb_MathPolygon.createPolygon([-outlineX, outlineY, 'L', -arcGap / 2, outlineY]);
				eda.pcb_PrimitivePolyline.create('line', EPCB_LayerId.TOP_SILKSCREEN, leftShortLine, 6);

				const rightShortLine = eda.pcb_MathPolygon.createPolygon([arcGap / 2, outlineY, 'L', outlineX, outlineY]);
				eda.pcb_PrimitivePolyline.create('line', EPCB_LayerId.TOP_SILKSCREEN, rightShortLine, 6);

				const connectingArc = eda.pcb_MathPolygon.createPolygon([-arcGap / 2, outlineY, 'ARC', 180, arcGap / 2, outlineY]);
				eda.pcb_PrimitivePolyline.create('line', EPCB_LayerId.TOP_SILKSCREEN, connectingArc, 6);

				console.log('SOP封装创建完成，总引脚数:', pinCount);
			}
		</script>
	</body>
</html>
